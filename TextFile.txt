BEGIN
	DECLARE @Enable bit = 1
	DECLARE @BaseFee decimal(18, 2) = 0
	DECLARE @ParentOrganizationId int = 0

	SET @ParentOrganizationId = @OrganizationId

	WHILE @BaseFee = 0 AND @ParentOrganizationId <> -1
	BEGIN
		IF @VisionType LIKE 'Single%'
			SELECT @BaseFee = Price FROM ElementPriceAssociation WHERE OrganizationId = @ParentOrganizationId AND ComponentId = 774 AND ComponentTypeId = 12 AND IsDisabled = 0
		ELSE
			SELECT @BaseFee = Price FROM ElementPriceAssociation WHERE OrganizationId = @ParentOrganizationId AND ComponentId = 976 AND ComponentTypeId = 12 AND IsDisabled = 0

		IF @BaseFee = 0
		BEGIN
			DECLARE @lensDataFromParent bit = 1
			SELECT @lensDataFromParent = lensDataFromParent FROM organization WHERE id = @ParentOrganizationId

			IF @lensDataFromParent = 1
				SELECT @ParentOrganizationId = ISNULL(parent_organization_id, -1) FROM organization WHERE id = @ParentOrganizationId
			ELSE
				BREAK
		
			IF @ParentOrganizationId = @OrganizationId
			BEGIN
				SET @ParentOrganizationId = -1
			END
			
		END
		
	END

	IF @BaseFee <> 0
		SET @OrganizationId = @ParentOrganizationId
		

	IF @OptionType = 'Progressives'
	BEGIN

	SELECT VLO.*, CASE WHEN VLO.AddonLensCode IS NULL THEN VLO.BaseLensCode ELSE VLO.AddonLensCode END AS 'SingleLensCode', ISNULL(EPA.Price, '0') AS 'Usual & Customary fee', CASE WHEN EPA.Price IS NULL THEN @Enable ELSE @Enable END AS 'Enable'
	, CASE WHEN EPA.Price IS NULL THEN 0 
		ELSE EPA.Price - (CASE WHEN VLO.LensCode LIKE '%+%' THEN 
										(SELECT TOP 1 ISNULL(EPATemp.Price, @BaseFee) FROM ElementPriceAssociation AS EPATemp 
										WHERE (EPATemp.ComponentId =(SELECT VLOTemp.VSPLensOptionId FROM VSPLensOptions AS VLOTemp 
																		WHERE (VLOTemp.OptionType = 'Progressives') AND (VLOTemp.LensCode = SUBSTRING(VLO.LensCode, 1, 2)))) AND (EPATemp.ComponentTypeId = 15) AND EPATemp.OrganizationId = @OrganizationId AND EPATemp.IsDisabled = 0) ELSE @BaseFee END) END AS 'Add-On Fees'
	FROM [VSPLensOptions] AS VLO
	LEFT OUTER JOIN 
	 (SELECT * FROM ElementPriceAssociation WHERE ComponentTypeId=15 AND OrganizationId = @OrganizationId AND IsDisabled = 0) AS EPA
	 ON VLO.VSPLensOptionId=EPA.ComponentId 
	WHERE (([VisionType] LIKE '%' + @VisionType + '%')  AND ([OptionType] LIKE @OptionType + '%') AND ([IsDeleted] != 1 ))

	END
	ELSE

	
	SELECT VLO.*, CASE WHEN VLO.RedirectLensCode IS NULL THEN (CASE WHEN VLO.AddonLensCode IS NULL THEN VLO.BaseLensCode ELSE VLO.AddonLensCode END) ELSE VLO.LensCode END AS 'SingleLensCode'
	, CASE WHEN VLO.RedirectLensCode IS NULL THEN ISNULL(EPA.Price, 0) 
		ELSE (SELECT Price FROM ElementPriceAssociation WHERE ComponentTypeId=15 AND OrganizationId = @OrganizationId AND IsDisabled = 0 AND ComponentId = (SELECT VSPLensOptionId FROM VSPLensOptions WHERE LensCode = VLO.RedirectLensCode AND ([VisionType] LIKE '%' + @VisionType + '%') AND ([IsDeleted] != 1 ) )) END  AS 'Usual & Customary fee'
	, CASE WHEN EPA.Price IS NULL THEN @Enable ELSE @Enable END AS 'Enable'
	, CASE WHEN EPA.Price IS NULL THEN 0 ELSE EPA.Price - @BaseFee END AS 'Add-On Fees'
	FROM [VSPLensOptions] AS VLO
	LEFT OUTER JOIN 
	 (SELECT * FROM ElementPriceAssociation WHERE ComponentTypeId=15 AND OrganizationId = @OrganizationId AND IsDisabled = 0) AS EPA
	 ON VLO.VSPLensOptionId=EPA.ComponentId 
	WHERE (([VisionType] LIKE '%' + @VisionType + '%')  AND ([OptionType] LIKE @OptionType + '%') AND ([IsDeleted] != 1 ))

END